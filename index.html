<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#0f1419">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>SIGMA - Croix Blanche</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23e63946' rx='20' width='100' height='100'/><text x='50' y='65' text-anchor='middle' font-size='50'>‚úö</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    :root {
      --bg-dark: #0f1419;
      --bg-card: #1a2332;
      --bg-input: #232f3e;
      --accent-red: #e63946;
      --accent-yellow: #f4a261;
      --accent-green: #2ec4b6;
      --accent-blue: #3a86ff;
      --accent-purple: #a855f7;
      --text-primary: #ffffff;
      --text-secondary: #8899a6;
      --text-muted: #5c6c7c;
      --border: #2d3f50;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      min-height: -webkit-fill-available;
      overflow-x: hidden;
    }

    .screen {
      display: none;
      min-height: 100vh;
      padding: 20px;
      padding-top: env(safe-area-inset-top, 20px);
      padding-bottom: calc(env(safe-area-inset-bottom, 20px) + 20px);
      animation: fadeIn 0.3s ease;
    }

    .screen.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .logo {
      text-align: center;
      margin: 60px 0 50px;
    }

    .logo-icon {
      width: 90px;
      height: 90px;
      background: linear-gradient(135deg, var(--accent-red), #ff6b6b);
      border-radius: 24px;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 42px;
      box-shadow: 0 15px 50px rgba(230, 57, 70, 0.35);
    }

    .logo h1 {
      font-size: 32px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .logo .acronym-detail {
      color: var(--text-muted);
      font-size: 11px;
      margin-top: 12px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    .logo .org-name {
      color: var(--accent-blue);
      font-size: 13px;
      font-weight: 600;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      display: inline-block;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 18px;
      background: var(--bg-input);
      border: 2px solid var(--border);
      border-radius: 14px;
      color: var(--text-primary);
      font-size: 17px;
      font-family: inherit;
      transition: all 0.2s;
      appearance: none;
    }

    .form-group select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%238899a6' stroke-width='2'%3E%3Cpolyline points='6,9 12,15 18,9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 16px center;
      padding-right: 50px;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 4px rgba(58, 134, 255, 0.15);
    }

    .form-group input::placeholder {
      color: var(--text-muted);
    }

    .code-input {
      font-family: 'JetBrains Mono', monospace;
      font-size: 28px !important;
      text-align: center;
      letter-spacing: 12px;
      padding-left: 24px !important;
    }

    .btn {
      width: 100%;
      padding: 18px;
      border: none;
      border-radius: 14px;
      font-size: 17px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-blue), #5a9cff);
      color: white;
      box-shadow: 0 8px 25px rgba(58, 134, 255, 0.35);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--accent-red), #ff6b6b);
      color: white;
      box-shadow: 0 8px 25px rgba(230, 57, 70, 0.35);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--accent-green), #5ce0d8);
      color: white;
      box-shadow: 0 8px 25px rgba(46, 196, 182, 0.35);
    }

    .btn-secondary {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 2px solid var(--border);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 24px;
    }

    .back-btn {
      width: 44px;
      height: 44px;
      background: var(--bg-card);
      border: none;
      border-radius: 14px;
      color: var(--text-primary);
      font-size: 22px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .back-btn:active {
      transform: scale(0.95);
      background: var(--bg-input);
    }

    .header-title {
      flex: 1;
    }

    .header-title h2 {
      font-size: 22px;
      font-weight: 700;
    }

    .header-title p {
      color: var(--text-secondary);
      font-size: 14px;
      margin-top: 2px;
    }

    .user-badge {
      background: var(--bg-card);
      padding: 10px 14px;
      border-radius: 25px;
      font-size: 13px;
      color: var(--accent-green);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .home-header {
      text-align: center;
      margin-bottom: 40px;
    }

    .home-header h2 {
      font-size: 26px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .home-header p {
      color: var(--text-secondary);
      font-size: 15px;
    }

    .mode-cards {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .mode-card {
      background: var(--bg-card);
      border-radius: 20px;
      padding: 24px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 18px;
    }

    .mode-card:active {
      transform: scale(0.98);
      border-color: var(--accent-blue);
    }

    .mode-icon {
      width: 64px;
      height: 64px;
      border-radius: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      flex-shrink: 0;
    }

    .mode-icon.intervention { background: linear-gradient(135deg, var(--accent-red), #ff6b6b); }
    .mode-icon.inventaire { background: linear-gradient(135deg, var(--accent-blue), #5a9cff); }
    .mode-icon.peremption { background: linear-gradient(135deg, var(--accent-yellow), #f4c994); }
    .mode-icon.vehicles { background: linear-gradient(135deg, var(--accent-green), #5ce0d8); }
    .mode-icon.qrcode { background: linear-gradient(135deg, var(--accent-purple), #c084fc); }

    .mode-info {
      flex: 1;
    }

    .mode-info h3 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .mode-info p {
      color: var(--text-secondary);
      font-size: 14px;
      line-height: 1.4;
    }

    .mode-badge {
      background: var(--accent-red);
      color: white;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      margin-left: auto;
    }

    .mode-arrow {
      color: var(--text-muted);
      font-size: 24px;
    }

    .logout-btn {
      margin-top: 40px;
      background: transparent;
      border: 2px solid var(--border);
      color: var(--text-secondary);
    }

    .scan-area {
      background: var(--bg-card);
      border-radius: 24px;
      padding: 24px;
      text-align: center;
      margin-bottom: 24px;
      border: 2px dashed var(--border);
    }

    .scan-area.scanning {
      border-style: solid;
      border-color: var(--accent-blue);
    }

    #qr-reader {
      width: 100%;
      max-width: 280px;
      height: 280px;
      margin: 0 auto 20px;
      border-radius: 16px;
      overflow: hidden;
      background: var(--bg-input);
    }

    #qr-reader video {
      border-radius: 16px;
    }

    .scan-placeholder {
      width: 100%;
      max-width: 220px;
      height: 220px;
      margin: 0 auto 20px;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .scan-placeholder::before,
    .scan-placeholder::after,
    .scan-placeholder .corner-tr,
    .scan-placeholder .corner-bl {
      content: '';
      position: absolute;
      width: 50px;
      height: 50px;
      border: 4px solid var(--accent-blue);
    }

    .scan-placeholder::before {
      top: 0; left: 0;
      border-right: none; border-bottom: none;
      border-radius: 12px 0 0 0;
    }

    .scan-placeholder::after {
      bottom: 0; right: 0;
      border-left: none; border-top: none;
      border-radius: 0 0 12px 0;
    }

    .scan-placeholder .corner-tr {
      top: 0; right: 0;
      border-left: none; border-bottom: none;
      border-radius: 0 12px 0 0;
    }

    .scan-placeholder .corner-bl {
      bottom: 0; left: 0;
      border-right: none; border-top: none;
      border-radius: 0 0 0 12px;
    }

    .scan-icon {
      font-size: 72px;
      opacity: 0.4;
    }

    .scan-area p {
      color: var(--text-secondary);
      font-size: 15px;
    }

    .scan-area .hint {
      color: var(--text-muted);
      font-size: 13px;
      margin-top: 8px;
    }

    .scan-btn {
      margin-top: 16px;
    }

    .divider {
      display: flex;
      align-items: center;
      gap: 16px;
      margin: 28px 0;
      color: var(--text-muted);
      font-size: 13px;
      font-weight: 500;
    }

    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .bag-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .bag-item {
      background: var(--bg-card);
      border-radius: 18px;
      padding: 18px;
      display: flex;
      align-items: center;
      gap: 16px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }

    .bag-item:active {
      transform: scale(0.98);
      border-color: var(--accent-blue);
    }

    .bag-item.has-alert {
      border-color: var(--accent-yellow);
    }

    .bag-icon {
      width: 54px;
      height: 54px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      position: relative;
    }

    .bag-icon.red { background: rgba(230, 57, 70, 0.15); }
    .bag-icon.blue { background: rgba(58, 134, 255, 0.15); }
    .bag-icon.green { background: rgba(46, 196, 182, 0.15); }
    .bag-icon.orange { background: rgba(244, 162, 97, 0.15); }

    .bag-icon .alert-dot {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 18px;
      height: 18px;
      background: var(--accent-red);
      border-radius: 50%;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
    }

    .bag-info {
      flex: 1;
    }

    .bag-info h4 {
      font-size: 16px;
      font-weight: 600;
    }

    .bag-info p {
      color: var(--text-secondary);
      font-size: 13px;
      margin-top: 3px;
    }

    .bag-status {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }

    .status-tag {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 6px;
      font-weight: 600;
    }

    .status-tag.ok { background: rgba(46, 196, 182, 0.15); color: var(--accent-green); }
    .status-tag.warning { background: rgba(244, 162, 97, 0.15); color: var(--accent-yellow); }
    .status-tag.critical { background: rgba(230, 57, 70, 0.15); color: var(--accent-red); }

    .bag-arrow {
      color: var(--text-muted);
      font-size: 24px;
    }

    .bag-header {
      background: linear-gradient(135deg, var(--accent-red), #ff6b6b);
      margin: -20px -20px 24px -20px;
      padding: 20px 20px 28px;
      padding-top: calc(env(safe-area-inset-top, 20px) + 10px);
      border-radius: 0 0 28px 28px;
    }

    .bag-header.blue { background: linear-gradient(135deg, var(--accent-blue), #5a9cff); }
    .bag-header.green { background: linear-gradient(135deg, var(--accent-green), #5ce0d8); }
    .bag-header.orange { background: linear-gradient(135deg, var(--accent-yellow), #f4c994); }

    .bag-header .back-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      margin-bottom: 16px;
    }

    .bag-header h2 {
      color: white;
      font-size: 26px;
      font-weight: 700;
    }

    .bag-header p {
      color: rgba(255,255,255,0.85);
      font-size: 14px;
      margin-top: 4px;
    }

    .bag-stats {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .stat {
      background: rgba(255,255,255,0.18);
      padding: 12px 16px;
      border-radius: 12px;
      flex: 1;
      text-align: center;
    }

    .stat-value {
      color: white;
      font-size: 22px;
      font-weight: 700;
    }

    .stat-label {
      color: rgba(255,255,255,0.75);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 2px;
    }

    .filter-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      overflow-x: auto;
      padding-bottom: 4px;
    }

    .filter-tab {
      padding: 10px 16px;
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: 25px;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .filter-tab.active {
      background: var(--accent-blue);
      border-color: var(--accent-blue);
      color: white;
    }

    .filter-tab .count {
      background: rgba(255,255,255,0.2);
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: 6px;
      font-size: 12px;
    }

    .filter-tab.active .count {
      background: rgba(255,255,255,0.3);
    }

    .pochon-section {
      margin-bottom: 28px;
    }

    .pochon-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 14px;
    }

    .pochon-dot {
      width: 14px;
      height: 14px;
      border-radius: 50%;
    }

    .pochon-dot.red { background: var(--accent-red); }
    .pochon-dot.yellow { background: var(--accent-yellow); }
    .pochon-dot.blue { background: var(--accent-blue); }
    .pochon-dot.green { background: var(--accent-green); }
    .pochon-dot.gray { background: var(--text-muted); }

    .pochon-header h3 {
      font-size: 15px;
      font-weight: 600;
      flex: 1;
    }

    .pochon-header span {
      color: var(--text-muted);
      font-size: 13px;
    }

    .item-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 10px;
      border: 2px solid transparent;
      transition: all 0.2s;
    }

    .item-card.selected {
      border-color: var(--accent-blue);
      background: rgba(58, 134, 255, 0.08);
    }

    .item-card.highlight-low {
      border-color: var(--accent-yellow);
      background: rgba(244, 162, 97, 0.08);
    }

    .item-card.highlight-critical {
      border-color: var(--accent-red);
      background: rgba(230, 57, 70, 0.08);
    }

    .item-card:active {
      transform: scale(0.99);
    }

    .item-icon {
      width: 46px;
      height: 46px;
      background: var(--bg-input);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
    }

    .item-details {
      flex: 1;
      min-width: 0;
    }

    .item-details h4 {
      font-size: 15px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .item-details p {
      color: var(--text-muted);
      font-size: 12px;
      margin-top: 2px;
    }

    .item-details .ecart {
      font-size: 12px;
      margin-top: 4px;
      font-weight: 600;
    }

    .item-details .ecart.negative { color: var(--accent-red); }
    .item-details .ecart.positive { color: var(--accent-green); }

    .stock-indicator {
      font-size: 12px;
      padding: 5px 10px;
      border-radius: 8px;
      font-weight: 600;
      font-family: 'JetBrains Mono', monospace;
    }

    .stock-ok { background: rgba(46, 196, 182, 0.15); color: var(--accent-green); }
    .stock-low { background: rgba(244, 162, 97, 0.15); color: var(--accent-yellow); }
    .stock-critical { background: rgba(230, 57, 70, 0.15); color: var(--accent-red); }

    .stock-display {
      text-align: center;
      min-width: 50px;
    }

    .stock-display .current {
      font-size: 20px;
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
    }

    .stock-display .target {
      font-size: 11px;
      color: var(--text-muted);
    }

    .item-qty {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .qty-btn {
      width: 38px;
      height: 38px;
      border-radius: 10px;
      border: 2px solid var(--border);
      background: var(--bg-input);
      color: var(--text-primary);
      font-size: 22px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      font-weight: 500;
    }

    .qty-btn:active {
      background: var(--accent-blue);
      border-color: var(--accent-blue);
      transform: scale(0.95);
    }

    .qty-value {
      min-width: 28px;
      text-align: center;
      font-weight: 700;
      font-size: 17px;
      font-family: 'JetBrains Mono', monospace;
    }

    .qty-value.active {
      color: var(--accent-blue);
    }

    .floating-container {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 16px 20px;
      padding-bottom: calc(env(safe-area-inset-bottom, 16px) + 16px);
      background: linear-gradient(to top, var(--bg-dark) 80%, transparent);
    }

    .inventory-content {
      padding-bottom: 100px;
    }

    .selection-summary {
      background: var(--bg-card);
      border-radius: 18px;
      padding: 18px;
      margin-bottom: 28px;
    }

    .selection-summary h3 {
      color: var(--text-secondary);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 14px;
      font-weight: 600;
    }

    .selected-items {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 180px;
      overflow-y: auto;
    }

    .selected-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg-input);
      border-radius: 12px;
    }

    .selected-item .emoji {
      font-size: 22px;
    }

    .selected-item .name {
      flex: 1;
      font-size: 14px;
      font-weight: 500;
    }

    .selected-item .qty {
      background: var(--accent-blue);
      color: white;
      padding: 5px 12px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
    }

    .destination-section h3 {
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 18px;
    }

    .destination-options {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .dest-option {
      background: var(--bg-card);
      border-radius: 18px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
    }

    .dest-option:active {
      transform: scale(0.98);
    }

    .dest-option.selected {
      border-color: var(--accent-blue);
      background: rgba(58, 134, 255, 0.08);
    }

    .dest-icon {
      width: 56px;
      height: 56px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
    }

    .dest-icon.victim { background: linear-gradient(135deg, var(--accent-red), #ff6b6b); }
    .dest-icon.transfer { background: linear-gradient(135deg, var(--accent-blue), #5a9cff); }
    .dest-icon.return { background: linear-gradient(135deg, var(--accent-green), #5ce0d8); }

    .dest-info {
      flex: 1;
    }

    .dest-info h4 {
      font-size: 16px;
      font-weight: 600;
    }

    .dest-info p {
      color: var(--text-secondary);
      font-size: 13px;
      margin-top: 3px;
    }

    .dest-check {
      width: 28px;
      height: 28px;
      border: 2px solid var(--border);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: transparent;
      font-size: 14px;
      transition: all 0.2s;
    }

    .dest-option.selected .dest-check {
      background: var(--accent-blue);
      border-color: var(--accent-blue);
      color: white;
    }

    .sub-options {
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid var(--border);
      width: 100%;
    }

    .sub-options select {
      width: 100%;
      padding: 14px;
      background: var(--bg-input);
      border: 2px solid var(--border);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 15px;
      font-family: inherit;
    }

    .confirm-section {
      margin-top: 28px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
    }

    .confirm-section .note {
      background: var(--bg-card);
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 18px;
    }

    .confirm-section .note textarea {
      width: 100%;
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-size: 15px;
      font-family: inherit;
      resize: none;
      height: 70px;
    }

    .confirm-section .note textarea::placeholder {
      color: var(--text-muted);
    }

    .peremption-item {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
      border: 2px solid transparent;
    }

    .peremption-item.expired {
      border-color: var(--accent-red);
      background: rgba(230, 57, 70, 0.08);
    }

    .peremption-item.warning {
      border-color: var(--accent-yellow);
      background: rgba(244, 162, 97, 0.08);
    }

    .peremption-item .item-row {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .peremption-item .location {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
    }

    .date-badge {
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      text-align: center;
      min-width: 90px;
    }

    .date-badge.expired {
      background: var(--accent-red);
      color: white;
    }

    .date-badge.warning {
      background: var(--accent-yellow);
      color: #1a1a1a;
    }

    .date-badge.ok {
      background: rgba(46, 196, 182, 0.15);
      color: var(--accent-green);
    }

    .date-badge .days {
      display: block;
      font-size: 11px;
      font-weight: 500;
      margin-top: 2px;
    }

    .alert-summary {
      background: var(--bg-card);
      border-radius: 18px;
      padding: 20px;
      margin-bottom: 24px;
      display: flex;
      gap: 16px;
    }

    .alert-box {
      flex: 1;
      text-align: center;
      padding: 16px;
      border-radius: 14px;
    }

    .alert-box.expired {
      background: rgba(230, 57, 70, 0.15);
    }

    .alert-box.warning {
      background: rgba(244, 162, 97, 0.15);
    }

    .alert-box .number {
      font-size: 32px;
      font-weight: 700;
    }

    .alert-box.expired .number { color: var(--accent-red); }
    .alert-box.warning .number { color: var(--accent-yellow); }

    .alert-box .label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--bg-card);
      color: var(--text-primary);
      padding: 16px 24px;
      border-radius: 14px;
      font-weight: 500;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
      opacity: 0;
      transition: all 0.3s;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .toast.success {
      background: var(--accent-green);
      color: white;
    }

    .toast.error {
      background: var(--accent-red);
      color: white;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 20, 25, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      flex-direction: column;
      gap: 20px;
    }

    .loading-overlay.show {
      display: flex;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--border);
      border-top-color: var(--accent-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      color: var(--text-secondary);
      font-size: 15px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state .icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state p {
      font-size: 15px;
    }

    .source-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 20, 25, 0.95);
      z-index: 1500;
      display: none;
      align-items: flex-end;
      justify-content: center;
    }

    .source-modal.show {
      display: flex;
    }

    .source-modal-content {
      background: var(--bg-card);
      border-radius: 28px 28px 0 0;
      padding: 24px 20px;
      padding-bottom: calc(env(safe-area-inset-bottom, 20px) + 20px);
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }

    .source-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .source-modal-header h3 {
      font-size: 20px;
      font-weight: 700;
    }

    .close-modal {
      width: 36px;
      height: 36px;
      background: var(--bg-input);
      border: none;
      border-radius: 50%;
      color: var(--text-primary);
      font-size: 20px;
      cursor: pointer;
    }

    .source-option {
      background: var(--bg-input);
      border-radius: 16px;
      padding: 18px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 14px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
    }

    .source-option:active {
      border-color: var(--accent-blue);
    }

    .source-option .icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .source-option .icon.armoire { background: rgba(244, 162, 97, 0.15); }
    .source-option .icon.sac { background: rgba(58, 134, 255, 0.15); }

    .source-option .info {
      flex: 1;
    }

    .source-option .info h4 {
      font-size: 15px;
      font-weight: 600;
    }

    .source-option .info p {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .source-option .stock-available {
      font-size: 14px;
      color: var(--accent-green);
      font-weight: 600;
    }

    /* QR Generator Styles */
    .qr-gen-controls {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
    }

    .qr-gen-mode-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      background: var(--bg-input);
      padding: 4px;
      border-radius: 12px;
    }

    .qr-gen-mode-tab {
      flex: 1;
      padding: 10px;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .qr-gen-mode-tab.active {
      background: var(--accent-purple);
      color: white;
    }

    .qr-gen-section {
      display: none;
    }

    .qr-gen-section.active {
      display: block;
    }

    .qr-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .qr-card-mini {
      background: var(--bg-card);
      border-radius: 14px;
      padding: 16px;
      text-align: center;
      border: 2px solid var(--border);
    }

    .qr-card-mini h4 {
      font-size: 14px;
      margin-bottom: 2px;
    }

    .qr-card-mini .qr-id {
      font-family: 'JetBrains Mono', monospace;
      color: var(--text-secondary);
      font-size: 11px;
      margin-bottom: 12px;
    }

    .qr-canvas-mini {
      margin: 12px auto;
      background: white;
      padding: 12px;
      border-radius: 10px;
      display: inline-block;
    }

    .qr-card-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .qr-card-actions button {
      flex: 1;
      padding: 8px;
      background: var(--bg-input);
      border: 2px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
    }

    .qr-card-actions button:active {
      transform: scale(0.95);
    }

    .info-banner {
      background: rgba(168, 85, 247, 0.1);
      border: 2px solid rgba(168, 85, 247, 0.3);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 20px;
      font-size: 13px;
      line-height: 1.6;
      color: var(--text-secondary);
    }

    .info-banner strong {
      color: var(--accent-purple);
    }

    /* Vehicle Styles */
    .vehicle-card {
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: 18px;
      padding: 20px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 18px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .vehicle-card:active {
      transform: scale(0.98);
      border-color: var(--accent-blue);
    }

    .vehicle-icon {
      width: 56px;
      height: 56px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      flex-shrink: 0;
    }

    .vehicle-icon.ambulance {
      background: linear-gradient(135deg, var(--accent-red), #ff6b6b);
    }

    .vehicle-icon.car {
      background: linear-gradient(135deg, var(--accent-blue), #5a9cff);
    }

    .vehicle-icon.quad {
      background: linear-gradient(135deg, var(--accent-yellow), #ffb347);
    }

    .vehicle-icon.boat {
      background: linear-gradient(135deg, var(--accent-purple), #c084fc);
    }

    .vehicle-icon.trailer {
      background: linear-gradient(135deg, #ff6b35, #ff8c5a);
    }

    .vehicle-info {
      flex: 1;
    }

    .vehicle-info h3 {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .vehicle-info p {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .stat-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      margin-right: 6px;
      margin-top: 4px;
      background: rgba(136, 153, 166, 0.15);
      color: var(--text-secondary);
    }

    .stat-badge.warning {
      background: rgba(244, 162, 97, 0.2);
      color: var(--accent-yellow);
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      overflow-x: auto;
      padding: 4px 0;
    }

    .tab {
      padding: 12px 20px;
      background: var(--bg-input);
      border: 2px solid var(--border);
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .tab.active {
      background: var(--accent-blue);
      border-color: var(--accent-blue);
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .info-grid {
      display: grid;
      gap: 16px;
    }

    .info-item {
      background: var(--bg-input);
      padding: 16px;
      border-radius: 12px;
      border: 2px solid var(--border);
    }

    .info-item label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.8px;
      margin-bottom: 8px;
    }

    .info-item .value {
      font-size: 15px;
      font-weight: 500;
      color: var(--text-primary);
    }

    /* Style bulles de conversation pour les √©v√©nements */
    .chat-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .message-bubble {
      display: flex;
      gap: 12px;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-blue), #5a9cff);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 600;
      color: white;
      flex-shrink: 0;
    }

    .message-content {
      flex: 1;
      max-width: 85%;
    }

    .message-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .author-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .message-date {
      font-size: 12px;
      color: var(--text-muted);
    }

    .bubble {
      background: var(--bg-card);
      border-radius: 16px;
      border-top-left-radius: 4px;
      padding: 14px 16px;
      position: relative;
      border: 2px solid var(--border);
    }

    .bubble.panne {
      border-left: 4px solid var(--accent-red);
      background: linear-gradient(90deg, rgba(230, 57, 70, 0.1) 0%, var(--bg-card) 20%);
    }

    .bubble.entretien {
      border-left: 4px solid var(--accent-green);
      background: linear-gradient(90deg, rgba(46, 196, 182, 0.1) 0%, var(--bg-card) 20%);
    }

    .bubble.info {
      border-left: 4px solid var(--accent-blue);
      background: linear-gradient(90deg, rgba(58, 134, 255, 0.1) 0%, var(--bg-card) 20%);
    }

    .event-type-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .event-type-badge.panne {
      background: rgba(230, 57, 70, 0.15);
      color: var(--accent-red);
    }

    .event-type-badge.entretien {
      background: rgba(46, 196, 182, 0.15);
      color: var(--accent-green);
    }

    .event-type-badge.info {
      background: rgba(58, 134, 255, 0.15);
      color: var(--accent-blue);
    }

    .event-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .event-description {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    /* Styles pour r√©visions et contrats */
    .revision-item, .contract-item {
      background: var(--bg-input);
      border: 2px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .revision-header, .contract-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }

    .event-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }

    .event-icon.entretien {
      background: rgba(46, 196, 182, 0.15);
      color: var(--accent-green);
    }

    .event-icon.info {
      background: rgba(58, 134, 255, 0.15);
      color: var(--accent-blue);
    }

    .revision-details h4, .contract-details h4 {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .revision-date, .contract-date {
      font-size: 12px;
      color: var(--text-muted);
    }

    .revision-notes, .contract-description {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.5;
      margin-top: 8px;
    }

    .next-revision-alert {
      background: linear-gradient(135deg, var(--accent-yellow), #ffb347);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 20px;
      color: white;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .next-revision-alert .icon {
      font-size: 32px;
    }

    .next-revision-alert h4 {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .next-revision-alert p {
      font-size: 13px;
      opacity: 0.9;
    }

    textarea {
      width: 100%;
      padding: 18px;
      background: var(--bg-input);
      border: 2px solid var(--border);
      border-radius: 14px;
      color: var(--text-primary);
      font-size: 17px;
      font-family: inherit;
      transition: all 0.2s;
      min-height: 120px;
      resize: vertical;
    }

    textarea:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 4px rgba(58, 134, 255, 0.15);
    }

    textarea::placeholder {
      color: var(--text-muted);
    }

    .modal-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 9998;
    }

    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      background: var(--bg-card);
      border-radius: 20px;
      padding: 24px;
    }

    .modal h3 {
      margin-bottom: 20px;
      font-size: 20px;
    }

    /* Spinner de chargement sur les boutons */
    .btn-loading {
      position: relative;
      pointer-events: none;
      opacity: 0.7;
    }

    .btn-loading::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      top: 50%;
      left: 50%;
      margin-left: -10px;
      margin-top: -10px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spinner 0.6s linear infinite;
    }

    @keyframes spinner {
      to { transform: rotate(360deg); }
    }

    .btn-loading span,
    .btn-loading::before {
      visibility: hidden;
    }
    
    /* Cacher tout le texte du bouton en loading */
    .btn-loading {
      color: transparent !important;
    }
  </style>
</head>
<body>

  <div class="loading-overlay" id="loading">
    <div class="spinner"></div>
    <div class="loading-text">Chargement...</div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="source-modal" id="source-modal">
    <div class="source-modal-content">
      <div class="source-modal-header">
        <h3>Compl√©ter depuis...</h3>
        <button class="close-modal" onclick="closeSourceModal()">√ó</button>
      </div>
      <div id="source-options"></div>
    </div>
  </div>

  <div class="screen active" id="screen-login">
    <div class="logo">
      <div class="logo-icon">‚úö</div>
      <h1>SIGMA</h1>
      <div class="acronym-detail">Suivi des Inventaires et Gestion du MAt√©riel</div>
      <div class="org-name">Secouristes Fran√ßais Croix Blanche</div>
    </div>

    <div class="form-group">
      <label>Identifiant</label>
      <select id="login-user">
        <option value="">Choisir un utilisateur...</option>
      </select>
    </div>

    <div class="form-group">
      <label>Code personnel</label>
      <input type="password" id="login-pin" class="code-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" inputmode="numeric">
    </div>

    <div style="height: 30px"></div>

    <button class="btn btn-primary" id="btn-login">
      Connexion
      <span>‚Üí</span>
    </button>
  </div>

  <div class="screen" id="screen-home">
    <div class="home-header">
      <h2>Bonjour <span id="home-user-name">-</span> üëã</h2>
      <p>Que souhaitez-vous faire ?</p>
    </div>

    <div class="mode-cards">
      <div class="mode-card" onclick="enterMode('intervention')">
        <div class="mode-icon intervention">üöë</div>
        <div class="mode-info">
          <h3>Intervention</h3>
          <p>Sortir du mat√©riel utilis√© sur victime ou transf√©rer entre sacs</p>
        </div>
        <span class="mode-arrow">‚Ä∫</span>
      </div>

      <div class="mode-card" onclick="enterMode('inventaire')">
        <div class="mode-icon inventaire">üìã</div>
        <div class="mode-info">
          <h3>Inventaire</h3>
          <p>V√©rifier le contenu d'un sac et compl√©ter les manques</p>
        </div>
        <span id="inventaire-badge" class="mode-badge" style="display: none;">!</span>
        <span class="mode-arrow">‚Ä∫</span>
      </div>

      <div class="mode-card" onclick="enterMode('peremption')">
        <div class="mode-icon peremption">‚è∞</div>
        <div class="mode-info">
          <h3>P√©remptions</h3>
          <p>G√©rer les dates de p√©remption du mat√©riel</p>
        </div>
        <span id="peremption-badge" class="mode-badge" style="display: none;">0</span>
        <span class="mode-arrow">‚Ä∫</span>
      </div>

      <div class="mode-card" onclick="enterMode('vehicles')">
        <div class="mode-icon vehicles">üöë</div>
        <div class="mode-info">
          <h3>V√©hicules</h3>
          <p>Parc, entretien et r√©visions</p>
        </div>
        <span class="mode-arrow">‚Ä∫</span>
      </div>

      <div class="mode-card" id="qr-generator-card" style="display: none;" onclick="enterMode('qrcode')">
        <div class="mode-icon qrcode">üî≤</div>
        <div class="mode-info">
          <h3>G√©n√©rateur QR</h3>
          <p>Cr√©er des QR codes pour les sacs</p>
        </div>
        <span class="mode-arrow">‚Ä∫</span>
      </div>
        </div>

    <button class="btn logout-btn" onclick="logout()">
      D√©connexion
    </button>
  </div>

  <div class="screen" id="screen-scan">
    <div class="header">
      <button class="back-btn" onclick="goToScreen('screen-home')">‚Üê</button>
      <div class="header-title">
        <h2>Intervention</h2>
        <p>Scannez ou choisissez un sac</p>
      </div>
      <div class="user-badge" id="user-badge">
        <span>üë§</span>
        <span id="current-user-name">-</span>
      </div>
    </div>

    <div class="scan-area" id="scan-area">
      <div id="qr-reader" style="display: none;"></div>
      <div class="scan-placeholder" id="scan-placeholder">
        <div class="corner-tr"></div>
        <div class="corner-bl"></div>
        <div class="scan-icon">üì∑</div>
      </div>
      <p>Scanner le QR code du sac</p>
      <p class="hint">Positionnez le code dans le cadre</p>
      <button class="btn btn-secondary scan-btn" id="btn-scan">
        üì∑ Activer la cam√©ra
      </button>
    </div>

    <div class="divider">ou s√©lectionner manuellement</div>

    <div class="bag-list" id="bag-list"></div>
  </div>

  <div class="screen" id="screen-inventory">
    <div class="bag-header" id="bag-header">
      <button class="back-btn" onclick="goToScreen('screen-scan')">‚Üê</button>
      <h2 id="bag-title">-</h2>
      <p id="bag-subtitle">-</p>
      <div class="bag-stats">
        <div class="stat">
          <div class="stat-value" id="stat-articles">0</div>
          <div class="stat-label">Articles</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="stat-pochons">0</div>
          <div class="stat-label">Pochons</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="stat-status">-</div>
          <div class="stat-label">√âtat</div>
        </div>
      </div>
    </div>

    <div class="inventory-content" id="inventory-content"></div>

    <div class="floating-container">
      <button class="btn btn-primary" id="btn-validate" disabled>
        Valider la sortie (<span id="selected-count">0</span> articles)
        <span>‚Üí</span>
      </button>
    </div>
  </div>

  <div class="screen" id="screen-destination">
    <div class="header">
      <button class="back-btn" onclick="goToScreen('screen-inventory')">‚Üê</button>
      <div class="header-title">
        <h2>Destination</h2>
        <p>O√π va ce mat√©riel ?</p>
      </div>
    </div>

    <div class="selection-summary">
      <h3>Mat√©riel s√©lectionn√©</h3>
      <div class="selected-items" id="selected-items"></div>
    </div>

    <div class="destination-section">
      <h3>Choisir la destination</h3>
      
      <div class="destination-options">
        <div class="dest-option selected" data-dest="victime" onclick="selectDestination(this)">
          <div class="dest-icon victim">üöë</div>
          <div class="dest-info">
            <h4>Utilis√© sur victime</h4>
            <p>Mat√©riel consomm√© lors d'une intervention</p>
          </div>
          <div class="dest-check">‚úì</div>
        </div>

        <div class="dest-option" data-dest="transfert" onclick="selectDestination(this)">
          <div class="dest-icon transfer">‚ÜîÔ∏è</div>
          <div class="dest-info">
            <h4>Transfert vers autre sac</h4>
            <p>D√©placer vers un autre contenant</p>
          </div>
          <div class="dest-check">‚úì</div>
          <div class="sub-options" style="display: none;">
            <select id="transfer-target">
              <option value="">Choisir le sac destination...</option>
            </select>
          </div>
        </div>

        <div class="dest-option" data-dest="retour" onclick="selectDestination(this)">
          <div class="dest-icon return">üóÑÔ∏è</div>
          <div class="dest-info">
            <h4>Retour armoire</h4>
            <p>R√©int√©grer dans la r√©serve</p>
          </div>
          <div class="dest-check">‚úì</div>
        </div>
      </div>
    </div>

    <div class="confirm-section">
      <div class="note">
        <textarea id="movement-note" placeholder="Note optionnelle (n¬∞ intervention, remarque...)"></textarea>
      </div>
      <button class="btn btn-danger" id="btn-confirm">
        ‚úì Confirmer la sortie
      </button>
    </div>
  </div>

  <div class="screen" id="screen-inventaire-select">
    <div class="header">
      <button class="back-btn" onclick="goToScreen('screen-home')">‚Üê</button>
      <div class="header-title">
        <h2>Inventaire</h2>
        <p>Choisissez un sac √† inventorier</p>
      </div>
    </div>

    <div class="bag-list" id="inventaire-bag-list"></div>
  </div>

  <div class="screen" id="screen-inventaire-detail">
    <div class="bag-header blue" id="inventaire-header">
      <button class="back-btn" onclick="goToScreen('screen-inventaire-select')">‚Üê</button>
      <h2 id="inventaire-title">-</h2>
      <p id="inventaire-subtitle">Inventaire du contenu</p>
      <div class="bag-stats">
        <div class="stat">
          <div class="stat-value" id="inventaire-stat-ok">0</div>
          <div class="stat-label">Complet</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="inventaire-stat-manque">0</div>
          <div class="stat-label">Manquant</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="inventaire-stat-exces">0</div>
          <div class="stat-label">Exc√®s</div>
        </div>
      </div>
    </div>

    <div class="filter-tabs" id="inventaire-filters">
      <button class="filter-tab active" data-filter="all" onclick="filterInventaire('all')">
        Tout
      </button>
      <button class="filter-tab" data-filter="manque" onclick="filterInventaire('manque')">
        Manquants <span class="count" id="filter-count-manque">0</span>
      </button>
      <button class="filter-tab" data-filter="exces" onclick="filterInventaire('exces')">
        Exc√®s <span class="count" id="filter-count-exces">0</span>
      </button>
    </div>

    <div class="inventory-content" id="inventaire-content"></div>

    <div class="floating-container" id="inventaire-floating" style="display: none;">
      <button class="btn btn-success" id="btn-completer">
        Compl√©ter les manques (<span id="manque-count">0</span>)
        <span>‚Üí</span>
      </button>
    </div>
  </div>

  <div class="screen" id="screen-peremption">
    <div class="header">
      <button class="back-btn" onclick="goToScreen('screen-home')">‚Üê</button>
      <div class="header-title">
        <h2>P√©remptions</h2>
        <p>Suivi des dates de validit√©</p>
      </div>
    </div>

    <div class="alert-summary" id="peremption-summary">
      <div class="alert-box expired">
        <div class="number" id="peremption-expired-count">0</div>
        <div class="label">P√©rim√©s</div>
      </div>
      <div class="alert-box warning">
        <div class="number" id="peremption-warning-count">0</div>
        <div class="label">< 30 jours</div>
      </div>
    </div>

    <div class="filter-tabs" id="peremption-filters">
      <button class="filter-tab active" data-filter="alerts" onclick="filterPeremption('alerts')">
        üö® Alertes
      </button>
      <button class="filter-tab" data-filter="all" onclick="filterPeremption('all')">
        Tous
      </button>
    </div>

    <div id="peremption-content"></div>
  </div>


  <div class="screen" id="screen-qrcode">
    <div class="header">
      <button class="back-btn" onclick="goToScreen('screen-home')">‚Üê</button>
      <div class="header-title">
        <h2>G√©n√©rateur QR</h2>
        <p>Cr√©ez vos QR codes</p>
      </div>
    </div>

    <div class="info-banner">
      <strong>üí° Comment l'utiliser :</strong><br>
      S√©lectionnez les sacs/armoires depuis Google Sheets, g√©n√©rez les QR codes, puis imprimez et plastifiez.
    </div>

    <div class="qr-gen-controls">
      <div id="contenant-selection-list"></div>
      
      <button class="btn btn-primary" onclick="generateQRFromSelection()" style="margin-top: 10px;">üî≤ G√©n√©rer les QR codes s√©lectionn√©s</button>
      <button class="btn btn-secondary" onclick="clearAllQR()" style="margin-top: 10px;">üóëÔ∏è Tout effacer</button>
    </div>

    <div class="qr-grid" id="qr-grid-main"></div>
  </div>


  <!-- Vehicles List Screen -->
  <div class="screen" id="screen-vehicles">
    <div class="header">
      <button class="back-btn" onclick="goToScreen('screen-home')">‚Üê</button>
      <div class="header-title">
        <h2>V√©hicules</h2>
        <p>Parc et entretien</p>
      </div>
    </div>

    <button class="btn btn-success" onclick="goToScreen('screen-add-vehicle')" style="margin-bottom: 20px">
      <span>‚ûï</span>
      Nouveau v√©hicule
    </button>

    <div class="filter-section">
      <div class="filter-tab active" data-filter="all" onclick="filterVehicles('all')">Tous</div>
      <div class="filter-tab" data-filter="car" onclick="filterVehicles('car')">üöó Voitures</div>
      <div class="filter-tab" data-filter="ambulance" onclick="filterVehicles('ambulance')">üöë Ambulances</div>
      <div class="filter-tab" data-filter="quad" onclick="filterVehicles('quad')">üèçÔ∏è Quad</div>
      <div class="filter-tab" data-filter="boat" onclick="filterVehicles('boat')">üö§ Bateau</div>
      <div class="filter-tab" data-filter="trailer" onclick="filterVehicles('trailer')">üöö Remorques</div>
    </div>

    <div id="vehicles-list"></div>
  </div>

  <!-- Add/Edit Vehicle Screen -->
  <div class="screen" id="screen-add-vehicle">
    <div class="header">
      <button class="back-btn" onclick="goToScreen('screen-vehicles')">‚Üê</button>
      <div class="header-title">
        <h2 id="vehicle-form-title">Nouveau v√©hicule</h2>
      </div>
    </div>

    <div class="form-group">
      <label>Nom du v√©hicule</label>
      <input type="text" id="vehicle-nom" placeholder="Ex: VSAV 1">
    </div>

    <div class="form-group">
      <label>Type</label>
      <select id="vehicle-type">
        <option value="ambulance">üöë Ambulance</option>
        <option value="car">üöó V√©hicule de liaison</option>
        <option value="car">üöó Jumpy de transport</option>
        <option value="quad">üèçÔ∏è Quad</option>
        <option value="boat">üö§ Bateau</option>
        <option value="trailer">üöö Remorque</option>
      </select>
    </div>

    <div class="form-group">
      <label>Immatriculation</label>
      <input type="text" id="vehicle-immat" placeholder="Ex: AB-123-CD" style="text-transform: uppercase">
    </div>

    <div class="form-group">
      <label>Marque</label>
      <input type="text" id="vehicle-marque" placeholder="Ex: Peugeot">
    </div>

    <div class="form-group">
      <label>Mod√®le</label>
      <input type="text" id="vehicle-modele" placeholder="Ex: Expert">
    </div>

    <div class="form-group">
      <label>Ann√©e</label>
      <input type="number" id="vehicle-annee" placeholder="Ex: 2020">
    </div>

    <div class="form-group">
      <label>Kilom√©trage actuel</label>
      <input type="number" id="vehicle-km" placeholder="Ex: 45000">
    </div>

    <button class="btn btn-success" onclick="saveVehicle()">
      <span>üíæ</span>
      Enregistrer
    </button>
  </div>

  <!-- Vehicle Detail Screen -->
  <div class="screen" id="screen-vehicle-detail">
    <div class="header">
      <button class="back-btn" onclick="goToScreen('screen-vehicles')">‚Üê</button>
      <div class="header-title">
        <h2 id="vehicle-detail-title">D√©tail v√©hicule</h2>
        <p id="vehicle-detail-subtitle"></p>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="info" onclick="switchVehicleTab('info')">
        üìã Infos
      </div>
      <div class="tab" data-tab="contracts" onclick="switchVehicleTab('contracts')">
        üìÑ Contrats
      </div>
      <div class="tab" data-tab="revisions" onclick="switchVehicleTab('revisions')">
        üîß R√©visions
      </div>
      <div class="tab" data-tab="events" onclick="switchVehicleTab('events')">
        üìù Journal
      </div>
    </div>

    <!-- Info Tab -->
    <div id="tab-info" class="tab-content active">
      <div id="vehicle-info-grid" class="info-grid"></div>
      <div style="display: flex; gap: 10px; margin-top: 20px">
        <button class="btn btn-primary" onclick="editVehicle()" style="flex: 1">
          <span>‚úèÔ∏è</span>
          Modifier
        </button>
        <button class="btn btn-danger" onclick="deleteVehicle()" style="flex: 1">
          <span>üóëÔ∏è</span>
          Supprimer
        </button>
      </div>
    </div>

    <!-- Contracts Tab -->
    <div id="tab-contracts" class="tab-content">
      <div id="next-contract-alert"></div>
      <button class="btn btn-success" onclick="showAddContractModal()" style="margin-bottom: 20px">
        <span>‚ûï</span>
        Ajouter un contrat
      </button>
      <div id="contracts-list"></div>
    </div>

    <!-- Revisions Tab -->
    <div id="tab-revisions" class="tab-content">
      <div id="next-revision-alert"></div>
      <button class="btn btn-success" onclick="showAddRevisionModal()" style="margin-bottom: 20px">
        <span>‚ûï</span>
        Ajouter une r√©vision
      </button>
      <div id="revisions-list"></div>
    </div>

    <!-- Events Tab -->
    <div id="tab-events" class="tab-content">
      <button class="btn btn-success" onclick="showAddEventModal()" style="margin-bottom: 20px">
        <span>‚ûï</span>
        Ajouter un √©v√©nement
      </button>
      <div id="events-list"></div>
    </div>
  </div>

  <!-- Modal Backdrop -->
  <div id="modal-backdrop" class="modal-backdrop" onclick="closeVehicleModal()"></div>

  <!-- Add Contract Modal -->
  <div id="modal-add-contract" class="modal">
    <h3>Ajouter un contrat</h3>
    <div class="form-group">
      <label>Type</label>
      <select id="contract-type">
        <option value="assurance">Assurance</option>
        <option value="entretien">Entretien</option>
      </select>
    </div>
    <div class="form-group">
      <label>Fournisseur</label>
      <input type="text" id="contract-fournisseur" placeholder="Ex: Groupama">
    </div>
    <div class="form-group">
      <label>Num√©ro de contrat</label>
      <input type="text" id="contract-numero" placeholder="Ex: 123456789">
    </div>
    <div class="form-group">
      <label>Date de d√©but</label>
      <input type="date" id="contract-date-debut">
    </div>
    <div class="form-group">
      <label>Date de fin</label>
      <input type="date" id="contract-date-fin">
    </div>
    <div class="form-group">
      <label>Description</label>
      <textarea id="contract-description" placeholder="D√©tails du contrat..."></textarea>
    </div>
    <div style="display: flex; gap: 10px">
      <button class="btn btn-secondary" onclick="closeVehicleModal()" style="flex: 1">Annuler</button>
      <button class="btn btn-success" onclick="saveContract()" style="flex: 1"><span>Enregistrer</span></button>
    </div>
  </div>

  <!-- Add Revision Modal -->
  <div id="modal-add-revision" class="modal">
    <h3>Ajouter une r√©vision</h3>
    <div class="form-group">
      <label>Date de r√©vision</label>
      <input type="date" id="revision-date">
    </div>
    <div class="form-group">
      <label>Kilom√©trage</label>
      <input type="number" id="revision-km" placeholder="Ex: 50000">
    </div>
    <div class="form-group">
      <label>Type de r√©vision</label>
      <input type="text" id="revision-type" placeholder="Ex: R√©vision compl√®te, Vidange...">
    </div>
    <div class="form-group">
      <label>Prochaine r√©vision (date)</label>
      <input type="date" id="revision-next-date">
    </div>
    <div class="form-group">
      <label>Compte rendu</label>
      <textarea id="revision-notes" placeholder="D√©tails de la r√©vision..."></textarea>
    </div>
    <div style="display: flex; gap: 10px">
      <button class="btn btn-secondary" onclick="closeVehicleModal()" style="flex: 1">Annuler</button>
      <button class="btn btn-success" onclick="saveRevision()" style="flex: 1"><span>Enregistrer</span></button>
    </div>
  </div>

  <!-- Add Event Modal -->
  <div id="modal-add-event" class="modal">
    <h3>Ajouter un √©v√©nement</h3>
    <div class="form-group">
      <label>Type</label>
      <select id="event-type">
        <option value="panne">üî¥ Panne</option>
        <option value="entretien">üîß Entretien</option>
        <option value="info">‚ÑπÔ∏è Information</option>
      </select>
    </div>
    <div class="form-group">
      <label>Titre</label>
      <input type="text" id="event-title" placeholder="Ex: Probl√®me de d√©marrage">
    </div>
    <div class="form-group">
      <label>Date</label>
      <input type="date" id="event-date">
    </div>
    <div class="form-group">
      <label>Description</label>
      <textarea id="event-description" placeholder="D√©tails de l'√©v√©nement..."></textarea>
    </div>
    <div style="display: flex; gap: 10px">
      <button class="btn btn-secondary" onclick="closeVehicleModal()" style="flex: 1">Annuler</button>
      <button class="btn btn-success" onclick="saveEvent()" style="flex: 1"><span>Enregistrer</span></button>
    </div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbyxFlO5vTm1l4iDwwvLyuyMu7oWwfAq6vEZxc-i1iy5j2PVM0FLzJpUVSLxOGTY6aeSoA/exec';

    let currentUser = null;
    let currentBag = null;
    let currentMode = null;
    let users = [];
    let contenants = [];
    let articles = [];
    let vehicles = [];
    let stock = [];
    let pochons = [];
    let selectedItems = {};
    let inventaireManques = [];
    let currentInventaireFilter = 'all';
    let currentPeremptionFilter = 'alerts';
    let qrScanner = null;

    document.addEventListener('DOMContentLoaded', async () => {
      await loadData();
    });

    async function loadData() {
      // Nettoyer l'ancien Service Worker
      if ('serviceWorker' in navigator) {
        const registrations = await navigator.serviceWorker.getRegistrations();
        for (const registration of registrations) {
          registration.unregister();
        }
        if ('caches' in window) {
          const keys = await caches.keys();
          for (const key of keys) {
            await caches.delete(key);
          }
        }
      }

      showLoading(true);
      try {
        const response = await fetch(`${API_URL}?action=getData`);
        const data = await response.json();
        users = data.users || [];
        contenants = data.contenants || [];
        articles = data.articles || [];
        stock = data.stock || [];
        pochons = data.pochons || [];
        vehicles = data.vehicles || [];
        populateUserSelect();
      } catch (error) {
        console.error('Error loading data:', error);
        showToast('Erreur de chargement', 'error');
      }
      showLoading(false);
    }

    function populateUserSelect() {
      const select = document.getElementById('login-user');
      select.innerHTML = '<option value="">Choisir un utilisateur...</option>';
      users.forEach(user => {
        select.innerHTML += `<option value="${user.id_utilisateur}">${user.nom}</option>`;
      });
    }

    document.getElementById('btn-login').addEventListener('click', login);
    document.getElementById('login-pin').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') login();
    });

    function login() {
      const userId = document.getElementById('login-user').value;
      const pin = document.getElementById('login-pin').value;

      if (!userId) {
        showToast('S√©lectionnez un utilisateur', 'error');
        return;
      }

      const user = users.find(u => u.id_utilisateur === userId);
      if (!user || String(user.code_pin) !== pin) {
        showToast('Code incorrect', 'error');
        document.getElementById('login-pin').value = '';
        return;
      }

      currentUser = user;
      document.getElementById('home-user-name').textContent = user.nom.split(' ')[0];
      document.getElementById('current-user-name').textContent = user.nom;
      
      // Afficher le g√©n√©rateur QR pour admin et logistique
      const qrCard = document.getElementById('qr-generator-card');
      if (user.role === 'admin' || user.role === 'logistique') {
        qrCard.style.display = 'flex';
      } else {
        qrCard.style.display = 'none';
      }
      
      updateHomeBadges();
      goToScreen('screen-home');
      showToast(`Bienvenue ${user.nom} !`, 'success');
    }

    function logout() {
      currentUser = null;
      currentBag = null;
      currentMode = null;
      selectedItems = {};
      document.getElementById('login-pin').value = '';
      stopScanner();
      goToScreen('screen-login');
    }

    function updateHomeBadges() {
      const peremptionAlerts = countPeremptionAlerts();
      const badge = document.getElementById('peremption-badge');
      if (peremptionAlerts.total > 0) {
        badge.textContent = peremptionAlerts.total;
        badge.style.display = 'block';
      } else {
        badge.style.display = 'none';
      }

      const totalManques = contenants.reduce((sum, bag) => {
        const bagStock = stock.filter(s => s.id_contenant === bag.id_contenant);
        return sum + bagStock.filter(s => s.quantite < s.quantite_cible).length;
      }, 0);
      
      const invBadge = document.getElementById('inventaire-badge');
      if (totalManques > 0) {
        invBadge.textContent = totalManques;
        invBadge.style.display = 'block';
      } else {
        invBadge.style.display = 'none';
      }
    }

    function enterMode(mode) {
      currentMode = mode;
      switch (mode) {
        case 'intervention': populateBagList(); goToScreen('screen-scan'); break;
        case 'inventaire': populateInventaireBagList(); goToScreen('screen-inventaire-select'); break;
        case 'peremption': populatePeremption(); goToScreen('screen-peremption'); break;
        case 'qrcode': populateContenantSelection(); goToScreen('screen-qrcode'); break;
        case 'vehicles': populateVehicles(); goToScreen('screen-vehicles'); break;
      }
    }

    function populateBagList() {
      const list = document.getElementById('bag-list');
      list.innerHTML = '';
      const sorted = [...contenants].sort((a, b) => a.type === 'armoire' ? 1 : b.type === 'armoire' ? -1 : 0);
      sorted.forEach(bag => {
        const bagStock = stock.filter(s => s.id_contenant === bag.id_contenant);
        const count = bagStock.reduce((sum, s) => sum + s.quantite, 0);
        const icon = bag.type === 'armoire' ? 'üóÑÔ∏è' : 'üéí';
        list.innerHTML += `
          <div class="bag-item" onclick="selectBag('${bag.id_contenant}')">
            <div class="bag-icon ${bag.couleur}">${icon}</div>
            <div class="bag-info">
              <h4>${bag.nom}</h4>
              <p>${bag.localisation} ‚Ä¢ ${count} articles</p>
            </div>
            <span class="bag-arrow">‚Ä∫</span>
          </div>`;
      });
    }

    function selectBag(bagId) {
      currentBag = contenants.find(c => c.id_contenant === bagId);
      selectedItems = {};
      populateInventory();
      goToScreen('screen-inventory');
    }

    document.getElementById('btn-scan').addEventListener('click', toggleScanner);

    async function toggleScanner() {
      const btn = document.getElementById('btn-scan');
      const placeholder = document.getElementById('scan-placeholder');
      const readerEl = document.getElementById('qr-reader');
      const scanArea = document.getElementById('scan-area');

      if (qrScanner) { stopScanner(); return; }

      try {
        placeholder.style.display = 'none';
        readerEl.style.display = 'block';
        scanArea.classList.add('scanning');
        btn.textContent = '‚èπ Arr√™ter le scan';
        qrScanner = new Html5Qrcode('qr-reader');
        await qrScanner.start({ facingMode: 'environment' }, { fps: 10, qrbox: { width: 250, height: 250 } }, onQrCodeScanned, () => {});
      } catch (error) {
        showToast('Impossible d\'acc√©der √† la cam√©ra', 'error');
        stopScanner();
      }
    }

    function stopScanner() {
      const btn = document.getElementById('btn-scan');
      const placeholder = document.getElementById('scan-placeholder');
      const readerEl = document.getElementById('qr-reader');
      const scanArea = document.getElementById('scan-area');
      if (qrScanner) { qrScanner.stop().catch(() => {}); qrScanner = null; }
      placeholder.style.display = 'flex';
      readerEl.style.display = 'none';
      scanArea.classList.remove('scanning');
      btn.textContent = 'üì∑ Activer la cam√©ra';
    }

    function onQrCodeScanned(qrCode) {
      const bag = contenants.find(c => c.id_contenant === qrCode);
      if (bag) { stopScanner(); selectBag(bag.id_contenant); showToast(`${bag.nom} identifi√© !`, 'success'); }
      else { showToast('QR code non reconnu', 'error'); }
    }

    function populateInventory() {
      const header = document.getElementById('bag-header');
      header.className = `bag-header ${currentBag.couleur}`;
      document.getElementById('bag-title').textContent = currentBag.nom;
      document.getElementById('bag-subtitle').textContent = currentBag.localisation;

      const bagStock = stock.filter(s => s.id_contenant === currentBag.id_contenant);
      const bagPochons = pochons.filter(p => p.id_contenant === currentBag.id_contenant);
      const total = bagStock.reduce((sum, s) => sum + s.quantite, 0);
      const hasIssues = bagStock.some(s => s.quantite < s.quantite_cible);

      document.getElementById('stat-articles').textContent = total;
      document.getElementById('stat-pochons').textContent = bagPochons.length || '-';
      document.getElementById('stat-status').textContent = hasIssues ? '‚ö†Ô∏è' : '‚úì';

      const content = document.getElementById('inventory-content');
      content.innerHTML = '';

      const grouped = {};
      bagStock.forEach(s => { const key = s.id_pochon || 'vrac'; if (!grouped[key]) grouped[key] = []; grouped[key].push(s); });

      const sortedKeys = Object.keys(grouped).sort((a, b) => {
        if (a === 'vrac') return 1; if (b === 'vrac') return -1;
        const pA = pochons.find(p => p.id_pochon === a);
        const pB = pochons.find(p => p.id_pochon === b);
        return (pA?.ordre || 0) - (pB?.ordre || 0);
      });

      sortedKeys.forEach(pochonId => {
        const items = grouped[pochonId];
        const pochon = pochons.find(p => p.id_pochon === pochonId) || { nom: 'Vrac', couleur: 'gray' };
        let html = `<div class="pochon-section"><div class="pochon-header"><div class="pochon-dot ${pochon.couleur}"></div><h3>${pochon.nom}</h3><span>${items.length} type${items.length > 1 ? 's' : ''}</span></div>`;
        items.forEach(item => {
          const article = articles.find(a => a.id_article === item.id_article) || {};
          const stockClass = item.quantite >= item.quantite_cible ? 'stock-ok' : item.quantite >= item.quantite_cible / 2 ? 'stock-low' : 'stock-critical';
          const selected = selectedItems[item.id_article] || 0;
          html += `<div class="item-card ${selected > 0 ? 'selected' : ''}" id="item-${item.id_article}"><div class="item-icon">${article.emoji || 'üì¶'}</div><div class="item-details"><h4>${article.nom || 'Article inconnu'}</h4><p>${article.description || ''}</p></div><span class="stock-indicator ${stockClass}">√ó${item.quantite}</span><div class="item-qty"><button class="qty-btn" onclick="updateQty('${item.id_article}', -1, ${item.quantite})">‚àí</button><span class="qty-value ${selected > 0 ? 'active' : ''}" id="qty-${item.id_article}">${selected}</span><button class="qty-btn" onclick="updateQty('${item.id_article}', 1, ${item.quantite})">+</button></div></div>`;
        });
        html += '</div>';
        content.innerHTML += html;
      });
      updateValidateButton();
    }

    function updateQty(articleId, delta, maxQty) {
      const current = selectedItems[articleId] || 0;
      const newQty = Math.max(0, Math.min(current + delta, maxQty));
      if (newQty === 0) delete selectedItems[articleId]; else selectedItems[articleId] = newQty;
      const qtyEl = document.getElementById(`qty-${articleId}`);
      const cardEl = document.getElementById(`item-${articleId}`);
      qtyEl.textContent = newQty;
      qtyEl.classList.toggle('active', newQty > 0);
      cardEl.classList.toggle('selected', newQty > 0);
      updateValidateButton();
    }

    function updateValidateButton() {
      const total = Object.values(selectedItems).reduce((sum, qty) => sum + qty, 0);
      document.getElementById('selected-count').textContent = total;
      document.getElementById('btn-validate').disabled = total === 0;
    }

    document.getElementById('btn-validate').addEventListener('click', () => { populateDestination(); goToScreen('screen-destination'); });

    function populateDestination() {
      const container = document.getElementById('selected-items');
      container.innerHTML = '';
      Object.entries(selectedItems).forEach(([articleId, qty]) => {
        const article = articles.find(a => a.id_article === articleId) || {};
        container.innerHTML += `<div class="selected-item"><span class="emoji">${article.emoji || 'üì¶'}</span><span class="name">${article.nom || 'Article'}</span><span class="qty">√ó${qty}</span></div>`;
      });

      const transferSelect = document.getElementById('transfer-target');
      transferSelect.innerHTML = '<option value="">Choisir le sac destination...</option>';
      const targets = currentBag.type === 'armoire' ? contenants.filter(c => c.type === 'sac') : contenants.filter(c => c.id_contenant !== currentBag.id_contenant && c.type === 'sac');
      targets.forEach(c => { transferSelect.innerHTML += `<option value="${c.id_contenant}">${c.nom}</option>`; });

      const retourOption = document.querySelector('[data-dest="retour"]');
      retourOption.style.display = currentBag.type === 'armoire' ? 'none' : '';

      document.querySelectorAll('.dest-option').forEach(el => el.classList.remove('selected'));
      document.querySelector('[data-dest="victime"]').classList.add('selected');
      document.getElementById('movement-note').value = '';
    }

    function selectDestination(el) {
      document.querySelectorAll('.dest-option').forEach(opt => { opt.classList.remove('selected'); const subOpts = opt.querySelector('.sub-options'); if (subOpts) subOpts.style.display = 'none'; });
      el.classList.add('selected');
      const subOpts = el.querySelector('.sub-options');
      if (subOpts) subOpts.style.display = 'block';
    }

    document.getElementById('btn-confirm').addEventListener('click', confirmMovement);

    async function confirmMovement() {
      const destOption = document.querySelector('.dest-option.selected');
      const destType = destOption.dataset.dest;
      const note = document.getElementById('movement-note').value;

      let destination = null;
      if (destType === 'transfert') { destination = document.getElementById('transfer-target').value; if (!destination) { showToast('S√©lectionnez un sac destination', 'error'); return; } }
      else if (destType === 'retour') { const armoire = contenants.find(c => c.type === 'armoire'); destination = armoire ? armoire.id_contenant : null; }

      const movements = Object.entries(selectedItems).map(([articleId, qty]) => ({
        date_heure: new Date().toISOString(), id_utilisateur: currentUser.id_utilisateur, id_article: articleId, quantite: qty,
        id_contenant_source: currentBag.id_contenant, id_contenant_destination: destination, type_mouvement: destType, note: note
      }));

      showLoading(true);
      try {
        await fetch(`${API_URL}?action=addMovements`, { method: 'POST', body: JSON.stringify({ movements }) });
        movements.forEach(mov => {
          const sourceStock = stock.find(s => s.id_contenant === mov.id_contenant_source && s.id_article === mov.id_article);
          if (sourceStock) sourceStock.quantite -= mov.quantite;
          if (mov.id_contenant_destination) { let destStock = stock.find(s => s.id_contenant === mov.id_contenant_destination && s.id_article === mov.id_article); if (destStock) destStock.quantite += mov.quantite; }
        });
        showToast('Mouvement enregistr√© !', 'success');
        selectedItems = {};
        updateHomeBadges();
        goToScreen('screen-home');
      } catch (error) { showToast('Erreur lors de l\'enregistrement', 'error'); }
      showLoading(false);
    }

    function populateInventaireBagList() {
      const list = document.getElementById('inventaire-bag-list');
      list.innerHTML = '';
      const sorted = [...contenants].sort((a, b) => a.type === 'armoire' ? 1 : b.type === 'armoire' ? -1 : 0);
      sorted.forEach(bag => {
        const bagStock = stock.filter(s => s.id_contenant === bag.id_contenant);
        const manques = bagStock.filter(s => s.quantite < s.quantite_cible).length;
        const exces = bagStock.filter(s => s.quantite > s.quantite_cible).length;
        const icon = bag.type === 'armoire' ? 'üóÑÔ∏è' : 'üéí';
        let statusTags = '';
        if (manques > 0) statusTags += `<span class="status-tag critical">${manques} manquant${manques > 1 ? 's' : ''}</span>`;
        if (exces > 0) statusTags += `<span class="status-tag warning">${exces} exc√®s</span>`;
        if (manques === 0 && exces === 0) statusTags = `<span class="status-tag ok">Complet ‚úì</span>`;
        list.innerHTML += `<div class="bag-item ${manques > 0 ? 'has-alert' : ''}" onclick="selectBagForInventaire('${bag.id_contenant}')"><div class="bag-icon ${bag.couleur}">${icon}${manques > 0 ? `<div class="alert-dot">${manques}</div>` : ''}</div><div class="bag-info"><h4>${bag.nom}</h4><p>${bag.localisation}</p><div class="bag-status">${statusTags}</div></div><span class="bag-arrow">‚Ä∫</span></div>`;
      });
    }

    function selectBagForInventaire(bagId) {
      currentBag = contenants.find(c => c.id_contenant === bagId);
      currentInventaireFilter = 'all';
      populateInventaireDetail();
      goToScreen('screen-inventaire-detail');
    }

    function populateInventaireDetail() {
      const header = document.getElementById('inventaire-header');
      header.className = `bag-header ${currentBag.couleur}`;
      document.getElementById('inventaire-title').textContent = currentBag.nom;
      const bagStock = stock.filter(s => s.id_contenant === currentBag.id_contenant);
      const okCount = bagStock.filter(s => s.quantite === s.quantite_cible).length;
      const manqueCount = bagStock.filter(s => s.quantite < s.quantite_cible).length;
      const excesCount = bagStock.filter(s => s.quantite > s.quantite_cible).length;
      document.getElementById('inventaire-stat-ok').textContent = okCount;
      document.getElementById('inventaire-stat-manque').textContent = manqueCount;
      document.getElementById('inventaire-stat-exces').textContent = excesCount;
      document.getElementById('filter-count-manque').textContent = manqueCount;
      document.getElementById('filter-count-exces').textContent = excesCount;
      inventaireManques = bagStock.filter(s => s.quantite < s.quantite_cible).map(s => ({ ...s, manque: s.quantite_cible - s.quantite }));
      const totalManques = inventaireManques.reduce((sum, m) => sum + m.manque, 0);
      document.getElementById('manque-count').textContent = totalManques;
      document.getElementById('inventaire-floating').style.display = totalManques > 0 ? 'block' : 'none';
      renderInventaireContent(bagStock);
    }

    function renderInventaireContent(bagStock) {
      const content = document.getElementById('inventaire-content');
      content.innerHTML = '';
      let filteredStock = bagStock;
      if (currentInventaireFilter === 'manque') filteredStock = bagStock.filter(s => s.quantite < s.quantite_cible);
      else if (currentInventaireFilter === 'exces') filteredStock = bagStock.filter(s => s.quantite > s.quantite_cible);
      if (filteredStock.length === 0) { content.innerHTML = `<div class="empty-state"><div class="icon">‚úì</div><p>Aucun article dans cette cat√©gorie</p></div>`; return; }
      const grouped = {};
      filteredStock.forEach(s => { const key = s.id_pochon || 'vrac'; if (!grouped[key]) grouped[key] = []; grouped[key].push(s); });
      const sortedKeys = Object.keys(grouped).sort((a, b) => { if (a === 'vrac') return 1; if (b === 'vrac') return -1; const pA = pochons.find(p => p.id_pochon === a); const pB = pochons.find(p => p.id_pochon === b); return (pA?.ordre || 0) - (pB?.ordre || 0); });
      sortedKeys.forEach(pochonId => {
        const items = grouped[pochonId];
        const pochon = pochons.find(p => p.id_pochon === pochonId) || { nom: 'Vrac', couleur: 'gray' };
        let html = `<div class="pochon-section"><div class="pochon-header"><div class="pochon-dot ${pochon.couleur}"></div><h3>${pochon.nom}</h3></div>`;
        items.forEach(item => {
          const article = articles.find(a => a.id_article === item.id_article) || {};
          const ecart = item.quantite - item.quantite_cible;
          let highlightClass = '', ecartText = '';
          if (ecart < 0) { highlightClass = Math.abs(ecart) >= item.quantite_cible / 2 ? 'highlight-critical' : 'highlight-low'; ecartText = `<span class="ecart negative">‚ö†Ô∏è ${Math.abs(ecart)} manquant${Math.abs(ecart) > 1 ? 's' : ''}</span>`; }
          else if (ecart > 0) { highlightClass = 'highlight-low'; ecartText = `<span class="ecart positive">‚Üë ${ecart} en plus</span>`; }
          html += `<div class="item-card ${highlightClass}"><div class="item-icon">${article.emoji || 'üì¶'}</div><div class="item-details"><h4>${article.nom || 'Article inconnu'}</h4><p>${article.description || ''}</p>${ecartText}</div><div class="stock-display"><div class="current">${item.quantite}</div><div class="target">/ ${item.quantite_cible}</div></div></div>`;
        });
        html += '</div>';
        content.innerHTML += html;
      });
    }

    function filterInventaire(filter) {
      currentInventaireFilter = filter;
      document.querySelectorAll('#inventaire-filters .filter-tab').forEach(tab => { tab.classList.toggle('active', tab.dataset.filter === filter); });
      const bagStock = stock.filter(s => s.id_contenant === currentBag.id_contenant);
      renderInventaireContent(bagStock);
    }

    document.getElementById('btn-completer').addEventListener('click', () => { openSourceModal(); });

    function openSourceModal() {
      const modal = document.getElementById('source-modal');
      const options = document.getElementById('source-options');
      options.innerHTML = '';
      const armoire = contenants.find(c => c.type === 'armoire');
      if (armoire && currentBag.id_contenant !== armoire.id_contenant) {
        options.innerHTML += `<div class="source-option" onclick="completerDepuis('${armoire.id_contenant}')"><div class="icon armoire">üóÑÔ∏è</div><div class="info"><h4>${armoire.nom}</h4><p>${armoire.localisation}</p></div><span class="stock-available">Stock disponible</span></div>`;
      }
      contenants.filter(c => c.id_contenant !== currentBag.id_contenant && c.type !== 'armoire').forEach(contenant => {
        options.innerHTML += `<div class="source-option" onclick="completerDepuis('${contenant.id_contenant}')"><div class="icon sac">üéí</div><div class="info"><h4>${contenant.nom}</h4><p>${contenant.localisation}</p></div></div>`;
      });
      if (options.innerHTML === '') { options.innerHTML = `<div class="empty-state" style="padding: 40px;"><div class="icon">üì¶</div><p>Aucune source disponible</p></div>`; }
      modal.classList.add('show');
    }

    function closeSourceModal() { document.getElementById('source-modal').classList.remove('show'); }

    async function completerDepuis(sourceId) {
      closeSourceModal();
      showLoading(true);
      const movements = [];
      inventaireManques.forEach(item => {
        const sourceStock = stock.find(s => s.id_contenant === sourceId && s.id_article === item.id_article);
        if (sourceStock && sourceStock.quantite > 0) {
          const qtyToMove = Math.min(item.manque, sourceStock.quantite);
          movements.push({ date_heure: new Date().toISOString(), id_utilisateur: currentUser.id_utilisateur, id_article: item.id_article, quantite: qtyToMove, id_contenant_source: sourceId, id_contenant_destination: currentBag.id_contenant, type_mouvement: 'reassort', note: 'Compl√©ment inventaire' });
        }
      });
      if (movements.length === 0) { showToast('Aucun article disponible dans cette source', 'error'); showLoading(false); return; }
      try {
        await fetch(`${API_URL}?action=addMovements`, { method: 'POST', body: JSON.stringify({ movements }) });
        movements.forEach(mov => {
          const sourceStock = stock.find(s => s.id_contenant === mov.id_contenant_source && s.id_article === mov.id_article);
          if (sourceStock) sourceStock.quantite -= mov.quantite;
          const destStock = stock.find(s => s.id_contenant === mov.id_contenant_destination && s.id_article === mov.id_article);
          if (destStock) destStock.quantite += mov.quantite;
        });
        const totalMoved = movements.reduce((sum, m) => sum + m.quantite, 0);
        showToast(`${totalMoved} article${totalMoved > 1 ? 's' : ''} ajout√©${totalMoved > 1 ? 's' : ''} !`, 'success');
        populateInventaireDetail();
        populateInventaireBagList();
        updateHomeBadges();
      } catch (error) { showToast('Erreur lors du r√©assort', 'error'); }
      showLoading(false);
    }

    function countPeremptionAlerts() {
      const today = new Date(); today.setHours(0, 0, 0, 0);
      let expired = 0, warning = 0;
      stock.forEach(item => {
        if (!item.date_peremption) return;
        const expDate = new Date(item.date_peremption);
        const diffDays = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
        if (diffDays < 0) expired++; else if (diffDays <= 30) warning++;
      });
      return { expired, warning, total: expired + warning };
    }

    function populatePeremption() {
      const alerts = countPeremptionAlerts();
      document.getElementById('peremption-expired-count').textContent = alerts.expired;
      document.getElementById('peremption-warning-count').textContent = alerts.warning;
      renderPeremptionContent();
    }

    function renderPeremptionContent() {
      const content = document.getElementById('peremption-content');
      content.innerHTML = '';
      const today = new Date(); today.setHours(0, 0, 0, 0);
      let items = stock.filter(s => s.date_peremption).map(s => {
        const expDate = new Date(s.date_peremption);
        const diffDays = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
        const article = articles.find(a => a.id_article === s.id_article) || {};
        const contenant = contenants.find(c => c.id_contenant === s.id_contenant) || {};
        return { ...s, article, contenant, diffDays, status: diffDays < 0 ? 'expired' : diffDays <= 30 ? 'warning' : 'ok' };
      }).sort((a, b) => a.diffDays - b.diffDays);
      if (currentPeremptionFilter === 'alerts') items = items.filter(i => i.status !== 'ok');
      if (items.length === 0) { content.innerHTML = `<div class="empty-state"><div class="icon">‚úì</div><p>${currentPeremptionFilter === 'alerts' ? 'Aucune alerte de p√©remption' : 'Aucun article avec date de p√©remption'}</p></div>`; return; }
      items.forEach(item => {
        const dateStr = new Date(item.date_peremption).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' });
        let daysText = item.diffDays < 0 ? `P√©rim√© depuis ${Math.abs(item.diffDays)}j` : item.diffDays === 0 ? "Expire aujourd'hui" : `Dans ${item.diffDays}j`;
        content.innerHTML += `<div class="peremption-item ${item.status}"><div class="item-row"><div class="item-icon">${item.article.emoji || 'üì¶'}</div><div class="item-details"><h4>${item.article.nom || 'Article'}</h4><p>√ó${item.quantite} ‚Ä¢ ${item.article.description || ''}</p></div><div class="date-badge ${item.status}">${dateStr}<span class="days">${daysText}</span></div></div><div class="location">üìç ${item.contenant.nom || 'Inconnu'}</div></div>`;
      });
    }

    function filterPeremption(filter) {
      currentPeremptionFilter = filter;
      document.querySelectorAll('#peremption-filters .filter-tab').forEach(tab => { tab.classList.toggle('active', tab.dataset.filter === filter); });
      renderPeremptionContent();
    }

    function goToScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
      window.scrollTo(0, 0);
      if (screenId !== 'screen-scan') stopScanner();
    }

    function showLoading(show) { document.getElementById('loading').classList.toggle('show', show); }

    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type}`;
      toast.classList.add('show');
      setTimeout(() => { toast.classList.remove('show'); }, 3000);
    }

    // ===== QR CODE GENERATOR FUNCTIONS =====
    let qrCounter = 0;
    let selectedContenants = new Set();

    function populateContenantSelection() {
      const list = document.getElementById('contenant-selection-list');
      list.innerHTML = '';
      
      if (contenants.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="icon">üì¶</div><p>Aucun contenant disponible.</p></div>';
        return;
      }

      contenants.forEach(contenant => {
        const iconClass = contenant.type === 'armoire' ? 'armoire' : 'sac';
        const icon = contenant.type === 'armoire' ? 'üóÑÔ∏è' : 'üéí';
        const isSelected = selectedContenants.has(contenant.id_contenant);
        
        const item = document.createElement('div');
        item.className = 'bag-card';
        item.style.cursor = 'pointer';
        item.style.position = 'relative';
        item.style.border = isSelected ? '2px solid var(--accent-primary)' : '2px solid var(--border-color)';
        item.style.background = isSelected ? 'var(--bg-highlight)' : 'var(--card-bg)';
        item.onclick = () => toggleContenantSelection(contenant.id_contenant);
        
        item.innerHTML = `
          <div class="bag-icon ${iconClass}">${icon}</div>
          <div class="bag-info">
            <h3>${contenant.nom}</h3>
            <p>${contenant.localisation}</p>
            <p class="bag-id">${contenant.id_contenant}</p>
          </div>
          ${isSelected ? '<div style="position: absolute; top: 10px; right: 10px; font-size: 24px;">‚úì</div>' : ''}
        `;
        list.appendChild(item);
      });
    }

    function toggleContenantSelection(id) {
      if (selectedContenants.has(id)) {
        selectedContenants.delete(id);
      } else {
        selectedContenants.add(id);
      }
      populateContenantSelection();
    }

    function generateQRFromSelection() {
      if (selectedContenants.size === 0) {
        showToast('Veuillez s√©lectionner au moins un contenant', 'error');
        return;
      }

      selectedContenants.forEach(id => {
        const contenant = contenants.find(c => c.id_contenant === id);
        if (contenant) {
          addQRCardToGrid(contenant.nom, contenant.id_contenant);
        }
      });

      showToast(`${selectedContenants.size} QR code${selectedContenants.size > 1 ? 's' : ''} g√©n√©r√©${selectedContenants.size > 1 ? 's' : ''} !`, 'success');
      selectedContenants.clear();
      populateContenantSelection();
    }

    function addQRCardToGrid(name, id) {
      qrCounter++;
      const cardId = 'qr-card-' + qrCounter;
      const canvasId = 'qr-canvas-' + qrCounter;

      const card = document.createElement('div');
      card.className = 'qr-card-mini';
      card.id = cardId;
      card.innerHTML = `
        <h4>${name}</h4>
        <div class="qr-id">${id}</div>
        <div id="${canvasId}" class="qr-canvas-mini"></div>
        <div class="qr-card-actions">
          <button onclick="downloadQRCode('${canvasId}', '${id}')">üíæ</button>
          <button onclick="removeQRCard('${cardId}')">üóëÔ∏è</button>
        </div>
      `;

      document.getElementById('qr-grid-main').appendChild(card);

      // G√©n√©rer le QR code avec QRCode.js
      setTimeout(() => {
        new QRCode(document.getElementById(canvasId), {
          text: id,
          width: 150,
          height: 150,
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.H
        });
      }, 100);
    }

    function downloadQRCode(canvasId, filename) {
      const canvas = document.querySelector(`#${canvasId} canvas`);
      if (!canvas) {
        showToast('Erreur lors de la g√©n√©ration du QR code', 'error');
        return;
      }

      // Cr√©er un canvas avec fond blanc et bordure
      const finalCanvas = document.createElement('canvas');
      const ctx = finalCanvas.getContext('2d');
      const padding = 30;
      finalCanvas.width = canvas.width + (padding * 2);
      finalCanvas.height = canvas.height + (padding * 2);

      // Fond blanc
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);

      // Copier le QR code
      ctx.drawImage(canvas, padding, padding);

      // T√©l√©charger
      finalCanvas.toBlob(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `QR_${filename}.png`;
        a.click();
        URL.revokeObjectURL(url);
        showToast('QR code t√©l√©charg√© !', 'success');
      });
    }

    function removeQRCard(cardId) {
      document.getElementById(cardId).remove();
      if (document.querySelectorAll('.qr-card-mini').length === 0) {
        qrCounter = 0;
      }
    }

    function clearAllQR() {
      const cards = document.querySelectorAll('.qr-card-mini');
      if (cards.length === 0) {
        showToast('Aucun QR code √† effacer', 'info');
        return;
      }

      if (confirm('Voulez-vous vraiment supprimer tous les QR codes g√©n√©r√©s ?')) {
        document.getElementById('qr-grid-main').innerHTML = '';
        qrCounter = 0;
        selectedContenants.clear();
        populateContenantSelection();
        showToast('QR codes effac√©s', 'success');
      }
    }

    // ===== VEHICLES MODULE =====
    let currentVehicleId = null;
    let currentVehicleFilter = 'all';
    let currentVehicleTab = 'info';

    async function loadVehiclesData() {
      // Les v√©hicules sont charg√©s avec getAllData au d√©marrage
    }

    function populateVehicles() {
      const list = document.getElementById('vehicles-list');
      list.innerHTML = '';
      let filtered = vehicles.filter(v => currentVehicleFilter === 'all' || v.type === currentVehicleFilter);
      if (filtered.length === 0) {
        list.innerHTML = '<div class="empty-state">üöó<br>Aucun v√©hicule enregistr√©</div>';
        return;
      }
      
      const today = new Date();
      const alertDays = 30; // Alerte 30 jours avant √©ch√©ance
      
      filtered.forEach(v => {
        const iconMap = { ambulance: 'üöë', car: 'üöó', quad: 'üèçÔ∏è', boat: 'üö§', trailer: 'üöö' };
        const icon = iconMap[v.type] || 'üöó';
        
        let alerts = []; // Tableau pour stocker toutes les alertes
        
        // V√©rifier les √©ch√©ances de r√©vision
        const revisions = v.revisions || [];
        const sorted = [...revisions].sort((a, b) => new Date(b.date) - new Date(a.date));
        const lastRevision = sorted[0];
        
        if (lastRevision && lastRevision.next_date) {
          const nextDate = new Date(lastRevision.next_date);
          const daysUntil = Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24));
          if (daysUntil <= alertDays && daysUntil >= 0) {
            alerts.push(`‚ö†Ô∏è R√©vision dans ${daysUntil}j`);
          } else if (daysUntil < 0) {
            alerts.push('‚ö†Ô∏è R√©vision d√©pass√©e');
          }
        }
        
        // V√©rifier les √©ch√©ances de contrats (trouver le plus urgent)
        const contracts = v.contracts || [];
        let closestContractDays = Infinity;
        let contractAlert = null;
        
        contracts.forEach(c => {
          if (c.date_fin) {
            const endDate = new Date(c.date_fin);
            const daysUntil = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
            
            // Contrat expir√© (priorit√© absolue)
            if (daysUntil < 0 && !contractAlert) {
              contractAlert = '‚ö†Ô∏è Contrat expir√©';
              closestContractDays = daysUntil;
            }
            // Contrat proche de l'expiration
            else if (daysUntil >= 0 && daysUntil <= alertDays && daysUntil < closestContractDays) {
              contractAlert = `‚ö†Ô∏è Contrat dans ${daysUntil}j`;
              closestContractDays = daysUntil;
            }
          }
        });
        
        if (contractAlert) {
          alerts.push(contractAlert);
        }
        
        // G√©n√©rer les badges d'alerte
        const alertBadges = alerts.map(alert => `<span class="stat-badge warning">${alert}</span>`).join('');
        
        list.innerHTML += `<div class="vehicle-card" onclick="showVehicleDetail('${v.id}')"><div class="vehicle-icon ${v.type}">${icon}</div><div class="vehicle-info"><h3>${v.nom}</h3><p>${v.marque} ${v.modele} - ${v.immat}</p><div style="margin-top: 8px"><span class="stat-badge">${v.km.toLocaleString()} km</span>${alertBadges}</div></div></div>`;
      });
    }

    function filterVehicles(filter) {
      currentVehicleFilter = filter;
      document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.filter === filter);
      });
      populateVehicles();
    }

    async function saveVehicle() {
      const nom = document.getElementById('vehicle-nom').value.trim();
      const type = document.getElementById('vehicle-type').value;
      const immat = document.getElementById('vehicle-immat').value.trim().toUpperCase();
      const marque = document.getElementById('vehicle-marque').value.trim();
      const modele = document.getElementById('vehicle-modele').value.trim();
      const annee = parseInt(document.getElementById('vehicle-annee').value) || 0;
      const km = parseInt(document.getElementById('vehicle-km').value) || 0;
      
      if (!nom || !immat || !marque || !modele) {
        showToast('Remplis tous les champs obligatoires', 'error');
        return;
      }
      
      const vehicle = {
        id: currentVehicleId || 'VEH' + String(Math.floor(Math.random() * 900) + 100).padStart(3, '0'),
        nom, type, immat, marque, modele, annee, km
      };
      
      // Ajouter le spinner au bouton
      const saveBtn = document.querySelector('#screen-add-vehicle .btn-success');
      if (saveBtn) saveBtn.classList.add('btn-loading');
      
      showLoading(true);
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify({ vehicle }),
          headers: { 'Content-Type': 'application/json' }
        });
        const url = `${API_URL}?action=saveVehicle`;
        const result = await fetch(url, {
          method: 'POST',
          body: JSON.stringify({ vehicle })
        }).then(r => r.json());
        
        if (result.success) {
          await loadData(); // Recharger toutes les donn√©es
          showToast('V√©hicule enregistr√© !', 'success');
          currentVehicleId = null;
          document.getElementById('vehicle-nom').value = '';
          document.getElementById('vehicle-immat').value = '';
          document.getElementById('vehicle-marque').value = '';
          document.getElementById('vehicle-modele').value = '';
          document.getElementById('vehicle-annee').value = '';
          document.getElementById('vehicle-km').value = '';
          populateVehicles();
          goToScreen('screen-vehicles');
        } else {
          showToast(result.error || 'Erreur d\'enregistrement', 'error');
        }
      } catch (error) {
        showToast('Erreur de connexion', 'error');
      }
      if (saveBtn) saveBtn.classList.remove('btn-loading');
      showLoading(false);
    }

    function showVehicleDetail(id) {
      currentVehicleId = id;
      const v = vehicles.find(ve => ve.id === id);
      if (!v) return;
      
      const iconMap = { ambulance: 'üöë', car: 'üöó', quad: 'üèçÔ∏è', boat: 'üö§', trailer: 'üöö' };
      const icon = iconMap[v.type] || 'üöó';
      
      document.getElementById('vehicle-detail-title').textContent = v.nom;
      document.getElementById('vehicle-detail-subtitle').textContent = `${icon} ${v.immat}`;
      
      populateVehicleInfo();
      populateVehicleContracts();
      populateVehicleRevisions();
      populateVehicleEvents();
      
      switchVehicleTab('info');
      goToScreen('screen-vehicle-detail');
    }

    function switchVehicleTab(tabName) {
      currentVehicleTab = tabName;
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
      });
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.id === 'tab-' + tabName);
      });
    }

    function populateVehicleInfo() {
      const v = vehicles.find(ve => ve.id === currentVehicleId);
      if (!v) return;
      
      const typeMap = {
        ambulance: 'üöë Ambulance', car: 'üöó Voiture',
        quad: 'üèçÔ∏è Quad', boat: 'üö§ Bateau', trailer: 'üöö Remorque'
      };
      
      const grid = document.getElementById('vehicle-info-grid');
      grid.innerHTML = `
        <div class="info-item"><label>Type</label><div class="value">${typeMap[v.type] || v.type}</div></div>
        <div class="info-item"><label>Immatriculation</label><div class="value">${v.immat}</div></div>
        <div class="info-item"><label>Marque</label><div class="value">${v.marque}</div></div>
        <div class="info-item"><label>Mod√®le</label><div class="value">${v.modele}</div></div>
        <div class="info-item"><label>Ann√©e</label><div class="value">${v.annee || 'Non renseign√©e'}</div></div>
        <div class="info-item"><label>Kilom√©trage</label><div class="value">${v.km ? v.km.toLocaleString() + ' km' : 'Non renseign√©'}</div></div>
      `;
    }

    function editVehicle() {
      const v = vehicles.find(ve => ve.id === currentVehicleId);
      if (!v) return;
      
      document.getElementById('vehicle-nom').value = v.nom;
      document.getElementById('vehicle-type').value = v.type;
      document.getElementById('vehicle-immat').value = v.immat;
      document.getElementById('vehicle-marque').value = v.marque;
      document.getElementById('vehicle-modele').value = v.modele;
      document.getElementById('vehicle-annee').value = v.annee || '';
      document.getElementById('vehicle-km').value = v.km || '';
      goToScreen('screen-add-vehicle');
    }

    async function deleteVehicle() {
      if (!confirm('Supprimer ce v√©hicule et toutes ses donn√©es ?')) return;
      
      showLoading(true);
      try {
        const url = `${API_URL}?action=deleteVehicle`;
        const result = await fetch(url, {
          method: 'POST',
          body: JSON.stringify({ id_vehicule: currentVehicleId })
        }).then(r => r.json());
        
        if (result.success) {
          await loadData();
          showToast('V√©hicule supprim√©', 'success');
          populateVehicles();
          goToScreen('screen-vehicles');
        } else {
          showToast(result.error || 'Erreur de suppression', 'error');
        }
      } catch (error) {
        showToast('Erreur de connexion', 'error');
      }
      showLoading(false);
    }

    function populateVehicleContracts() {
      const v = vehicles.find(ve => ve.id === currentVehicleId);
      if (!v) return;
      
      const alert = document.getElementById('next-contract-alert');
      const list = document.getElementById('contracts-list');
      
      alert.innerHTML = '';
      list.innerHTML = '';
      
      if (!v.contracts || v.contracts.length === 0) {
        list.innerHTML = '<div class="empty-state">üìÑ<br>Aucun contrat enregistr√©</div>';
        return;
      }
      
      const today = new Date();
      const alertDays = 30;
      
      // Trouver le contrat le plus proche de son expiration
      let closestContract = null;
      let closestDays = Infinity;
      let hasExpired = false;
      
      v.contracts.forEach(contract => {
        const endDate = new Date(contract.date_fin);
        const daysUntil = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
        
        if (daysUntil < 0 && !hasExpired) {
          // Contrat expir√©
          hasExpired = true;
          closestContract = contract;
          closestDays = daysUntil;
        } else if (daysUntil >= 0 && daysUntil <= alertDays && daysUntil < closestDays) {
          // Contrat proche de l'expiration
          closestContract = contract;
          closestDays = daysUntil;
        }
      });
      
      // Afficher l'alerte pour le contrat le plus urgent
      if (closestContract) {
        const endDate = new Date(closestContract.date_fin);
        const daysUntil = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
        const contractType = closestContract.type === 'assurance' ? 'Assurance' : 'Contrat d\'entretien';
        
        if (daysUntil < 0) {
          alert.innerHTML = `
            <div class="next-revision-alert" style="background: linear-gradient(135deg, var(--accent-red), #ff6b6b);">
              <div class="icon">üö®</div>
              <div>
                <h4>Contrat expir√© !</h4>
                <p>${contractType} de ${closestContract.fournisseur} expir√© depuis ${Math.abs(daysUntil)} jour${Math.abs(daysUntil) > 1 ? 's' : ''}</p>
              </div>
            </div>
          `;
        } else if (daysUntil <= alertDays) {
          alert.innerHTML = `
            <div class="next-revision-alert">
              <div class="icon">‚ö†Ô∏è</div>
              <div>
                <h4>Contrat proche de l'expiration !</h4>
                <p>${contractType} de ${closestContract.fournisseur} expire dans ${daysUntil} jour${daysUntil > 1 ? 's' : ''} (${endDate.toLocaleDateString('fr-FR')})</p>
              </div>
            </div>
          `;
        }
      }
      
      // Afficher tous les contrats
      v.contracts.forEach(contract => {
        const typeIcon = contract.type === 'assurance' ? 'üõ°Ô∏è' : 'üîß';
        const dateDebut = new Date(contract.date_debut).toLocaleDateString('fr-FR');
        const dateFin = new Date(contract.date_fin).toLocaleDateString('fr-FR');
        const endDate = new Date(contract.date_fin);
        const daysUntil = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
        
        let alertBadge = '';
        if (daysUntil <= alertDays && daysUntil >= 0) {
          alertBadge = `<span class="stat-badge warning">‚ö†Ô∏è Expire dans ${daysUntil}j</span>`;
        } else if (daysUntil < 0) {
          alertBadge = '<span class="stat-badge warning" style="background: rgba(230, 57, 70, 0.2);">üö® Expir√©</span>';
        }
        
        list.innerHTML += `
          <div class="contract-item">
            <div class="contract-header">
              <div class="event-icon info">${typeIcon}</div>
              <div class="contract-details">
                <h4>${contract.type === 'assurance' ? 'Assurance' : 'Contrat d\'entretien'} - ${contract.fournisseur} ${alertBadge}</h4>
                <div class="contract-date">N¬∞ ${contract.numero}</div>
              </div>
            </div>
            <div class="contract-description">
              <strong>P√©riode:</strong> ${dateDebut} ‚Üí ${dateFin}<br>
              ${contract.description || ''}
            </div>
          </div>
        `;
      });
    }

    function populateVehicleRevisions() {
      const v = vehicles.find(ve => ve.id === currentVehicleId);
      if (!v) return;
      
      const alert = document.getElementById('next-revision-alert');
      const list = document.getElementById('revisions-list');
      
      alert.innerHTML = '';
      list.innerHTML = '';
      
      if (!v.revisions || v.revisions.length === 0) {
        list.innerHTML = '<div class="empty-state">üîß<br>Aucune r√©vision enregistr√©e</div>';
        return;
      }
      
      const sorted = [...v.revisions].sort((a, b) => new Date(b.date) - new Date(a.date));
      const last = sorted[0];
      
      // Alerte bas√©e sur la DATE de prochaine r√©vision
      if (last.next_date) {
        const today = new Date();
        const nextDate = new Date(last.next_date);
        const daysUntil = Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24));
        const alertDays = 30; // Alerte 30 jours avant
        
        if (daysUntil <= alertDays && daysUntil >= 0) {
          alert.innerHTML = `
            <div class="next-revision-alert">
              <div class="icon">‚ö†Ô∏è</div>
              <div>
                <h4>R√©vision proche !</h4>
                <p>Prochaine r√©vision dans ${daysUntil} jour${daysUntil > 1 ? 's' : ''} (${nextDate.toLocaleDateString('fr-FR')})</p>
              </div>
            </div>
          `;
        } else if (daysUntil < 0) {
          alert.innerHTML = `
            <div class="next-revision-alert" style="background: linear-gradient(135deg, var(--accent-red), #ff6b6b);">
              <div class="icon">üö®</div>
              <div>
                <h4>R√©vision d√©pass√©e !</h4>
                <p>La r√©vision devait avoir lieu le ${nextDate.toLocaleDateString('fr-FR')}</p>
              </div>
            </div>
          `;
        }
      }
      
      sorted.forEach(revision => {
        const date = new Date(revision.date).toLocaleDateString('fr-FR');
        const nextDate = revision.next_date ? new Date(revision.next_date).toLocaleDateString('fr-FR') : 'Non d√©finie';
        
        list.innerHTML += `
          <div class="revision-item">
            <div class="revision-header">
              <div class="event-icon entretien">üîß</div>
              <div class="revision-details">
                <h4>${revision.type}</h4>
                <div class="revision-date">${date} - ${revision.km.toLocaleString()} km</div>
              </div>
            </div>
            <div class="revision-notes">
              <strong>Prochaine r√©vision pr√©vue :</strong><br>
              üìÖ ${nextDate}<br><br>
              ${revision.notes || ''}
            </div>
          </div>
        `;
      });
    }

    function populateVehicleEvents() {
      const v = vehicles.find(ve => ve.id === currentVehicleId);
      if (!v) return;
      
      const list = document.getElementById('events-list');
      list.innerHTML = '';
      
      if (!v.events || v.events.length === 0) {
        list.innerHTML = '<div class="empty-state">üìù<br>Aucun √©v√©nement enregistr√©</div>';
        return;
      }
      
      // Trier du plus ancien au plus r√©cent
      const sorted = [...v.events].sort((a, b) => new Date(a.date) - new Date(b.date));
      
      // Cr√©er le conteneur de chat
      const chatContainer = document.createElement('div');
      chatContainer.className = 'chat-container';
      
      sorted.forEach(event => {
        const iconMap = { panne: 'üî¥', entretien: 'üîß', info: '‚ÑπÔ∏è' };
        const typeMap = { panne: 'Panne', entretien: 'Entretien', info: 'Information' };
        const icon = iconMap[event.type] || '‚ÑπÔ∏è';
        const typeLabel = typeMap[event.type] || 'Info';
        
        // Formater la date avec heure si disponible
        const dateObj = new Date(event.date);
        const dateStr = dateObj.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' });
        const timeStr = dateObj.getHours() === 0 ? '' : dateObj.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        const fullDate = timeStr ? `${dateStr} ‚Ä¢ ${timeStr}` : dateStr;
        
        // Obtenir les initiales de l'utilisateur
        const userName = event.user_name || 'Utilisateur inconnu';
        const initials = userName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        bubble.innerHTML = `
          <div class="avatar">${initials}</div>
          <div class="message-content">
            <div class="message-header">
              <span class="author-name">${userName}</span>
              <span class="message-date">${fullDate}</span>
            </div>
            <div class="bubble ${event.type}">
              <div class="event-type-badge ${event.type}">${icon} ${typeLabel}</div>
              <div class="event-title">${event.title}</div>
              <div class="event-description">${event.description || ''}</div>
            </div>
          </div>
        `;
        
        chatContainer.appendChild(bubble);
      });
      
      list.appendChild(chatContainer);
    }

    function closeVehicleModal() {
      document.getElementById('modal-backdrop').style.display = 'none';
      document.getElementById('modal-add-contract').style.display = 'none';
      document.getElementById('modal-add-revision').style.display = 'none';
      document.getElementById('modal-add-event').style.display = 'none';
    }

    function showAddContractModal() {
      document.getElementById('contract-type').value = 'assurance';
      document.getElementById('contract-fournisseur').value = '';
      document.getElementById('contract-numero').value = '';
      document.getElementById('contract-date-debut').value = '';
      document.getElementById('contract-date-fin').value = '';
      document.getElementById('contract-description').value = '';
      document.getElementById('modal-backdrop').style.display = 'block';
      document.getElementById('modal-add-contract').style.display = 'block';
    }

    async function saveContract() {
      const type = document.getElementById('contract-type').value;
      const fournisseur = document.getElementById('contract-fournisseur').value.trim();
      const numero = document.getElementById('contract-numero').value.trim();
      const date_debut = document.getElementById('contract-date-debut').value;
      const date_fin = document.getElementById('contract-date-fin').value;
      const description = document.getElementById('contract-description').value.trim();
      
      if (!fournisseur || !numero || !date_debut || !date_fin) {
        showToast('Remplis tous les champs', 'error');
        return;
      }
      
      const contract = {
        id_vehicule: currentVehicleId,
        type, fournisseur, numero, date_debut, date_fin, description
      };
      
      // Ajouter le spinner au bouton
      const saveBtn = document.querySelector('#modal-add-contract .btn-success');
      if (saveBtn) saveBtn.classList.add('btn-loading');
      
      showLoading(true);
      try {
        const url = `${API_URL}?action=addContract`;
        const result = await fetch(url, {
          method: 'POST',
          body: JSON.stringify({ contract })
        }).then(r => r.json());
        
        if (result.success) {
          await loadData();
          showToast('Contrat ajout√© !', 'success');
          showVehicleDetail(currentVehicleId);
          switchVehicleTab('contracts');
          closeVehicleModal();
        } else {
          showToast(result.error || 'Erreur d\'ajout', 'error');
        }
      } catch (error) {
        showToast('Erreur de connexion', 'error');
      }
      if (saveBtn) saveBtn.classList.remove('btn-loading');
      showLoading(false);
    }

    function showAddRevisionModal() {
      document.getElementById('revision-date').value = new Date().toISOString().split('T')[0];
      document.getElementById('revision-km').value = '';
      document.getElementById('revision-type').value = '';
      document.getElementById('revision-next-date').value = '';
      document.getElementById('revision-notes').value = '';
      document.getElementById('modal-backdrop').style.display = 'block';
      document.getElementById('modal-add-revision').style.display = 'block';
    }

    async function saveRevision() {
      const date = document.getElementById('revision-date').value;
      const km = parseInt(document.getElementById('revision-km').value);
      const type = document.getElementById('revision-type').value.trim();
      const next_date = document.getElementById('revision-next-date').value || null;
      const notes = document.getElementById('revision-notes').value.trim();
      
      if (!date || !km || !type) {
        showToast('Remplis les champs obligatoires', 'error');
        return;
      }
      
      const revision = {
        id_vehicule: currentVehicleId,
        date, km, type, next_date, notes
      };
      
      // Ajouter le spinner au bouton
      const saveBtn = document.querySelector('#modal-add-revision .btn-success');
      if (saveBtn) saveBtn.classList.add('btn-loading');
      
      showLoading(true);
      try {
        const url = `${API_URL}?action=addRevision`;
        const result = await fetch(url, {
          method: 'POST',
          body: JSON.stringify({ revision })
        }).then(r => r.json());
        
        if (result.success) {
          await loadData();
          showToast('R√©vision ajout√©e !', 'success');
          showVehicleDetail(currentVehicleId);
          switchVehicleTab('revisions');
          closeVehicleModal();
        } else {
          showToast(result.error || 'Erreur d\'ajout', 'error');
        }
      } catch (error) {
        showToast('Erreur de connexion', 'error');
      }
      if (saveBtn) saveBtn.classList.remove('btn-loading');
      showLoading(false);
    }

    function showAddEventModal() {
      document.getElementById('event-type').value = 'info';
      document.getElementById('event-title').value = '';
      document.getElementById('event-date').value = new Date().toISOString().split('T')[0];
      document.getElementById('event-description').value = '';
      document.getElementById('modal-backdrop').style.display = 'block';
      document.getElementById('modal-add-event').style.display = 'block';
    }

    async function saveEvent() {
      const type = document.getElementById('event-type').value;
      const title = document.getElementById('event-title').value.trim();
      const date = document.getElementById('event-date').value;
      const description = document.getElementById('event-description').value.trim();
      
      if (!title || !date) {
        showToast('Remplis les champs obligatoires', 'error');
        return;
      }
      
      const event = {
        id_vehicule: currentVehicleId,
        id_utilisateur: currentUser.id,  // Ajouter l'utilisateur connect√©
        type, title, date, description
      };
      
      console.log('üîç Debug saveEvent:', {
        currentUser: currentUser,
        id_utilisateur: currentUser.id,
        event: event
      });
      
      // Ajouter le spinner au bouton
      const saveBtn = document.querySelector('#modal-add-event .btn-success');
      if (saveBtn) saveBtn.classList.add('btn-loading');
      
      showLoading(true);
      try {
        const url = `${API_URL}?action=addEvent`;
        const result = await fetch(url, {
          method: 'POST',
          body: JSON.stringify({ event })
        }).then(r => r.json());
        
        if (result.success) {
          await loadData();
          showToast('√âv√©nement ajout√© !', 'success');
          showVehicleDetail(currentVehicleId);
          switchVehicleTab('events');
          closeVehicleModal();
        } else {
          showToast(result.error || 'Erreur d\'ajout', 'error');
        }
      } catch (error) {
        showToast('Erreur de connexion', 'error');
      }
      if (saveBtn) saveBtn.classList.remove('btn-loading');
      showLoading(false);
    }

  </script>
</body>
</html>